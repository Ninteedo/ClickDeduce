


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > WebServer</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">app</a>
</div>

<h1>Coverage Summary for Class: WebServer (app)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WebServer</td>
<td class="coverageStat">
  <span class="percent">
    91.9%
  </span>
  <span class="absValue">
    (34/37)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    8%
  </span>
  <span class="absValue">
    (29/362)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    74.8%
  </span>
  <span class="absValue">
    (83/111)
  </span>
</td>
</tr>
  <tr>
    <td class="name">WebServer$</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebServer$$anon$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebServer$package</td>
  </tr>
  <tr>
    <td class="name">WebServer$package$</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebServer$package$$anon$2</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (2/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    85.4%
  </span>
  <span class="absValue">
    (41/48)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    9.2%
  </span>
  <span class="absValue">
    (34/370)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75.7%
  </span>
  <span class="absValue">
    (103/136)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package app
&nbsp;
&nbsp;import akka.actor.ActorSystem
&nbsp;import akka.http.scaladsl.Http
&nbsp;import akka.http.scaladsl.marshallers.sprayjson.SprayJsonSupport
&nbsp;import akka.http.scaladsl.model.{HttpEntity, HttpResponse, StatusCodes}
&nbsp;import akka.http.scaladsl.server.Directives.*
&nbsp;import akka.http.scaladsl.server.{ExceptionHandler, Route}
&nbsp;import akka.http.scaladsl.settings.ServerSettings
&nbsp;import languages.*
&nbsp;import scalatags.Text.TypedTag
&nbsp;import scalatags.Text.all.*
&nbsp;import spray.json.{DefaultJsonProtocol, RootJsonFormat}
&nbsp;
&nbsp;import java.io.File
&nbsp;import scala.concurrent.ExecutionContextExecutor
&nbsp;import scala.sys.process.Process
&nbsp;
&nbsp;case class EvalRequest(langName: String)
&nbsp;
&nbsp;case class NodeResponse(nodeString: String, html: String)
&nbsp;
&nbsp;case class ActionRequest(
&nbsp;  langName: String,
&nbsp;  modeName: String,
&nbsp;  actionName: String,
&nbsp;  nodeString: String,
&nbsp;  treePath: String,
&nbsp;  extraArgs: List[String]
&nbsp;)
&nbsp;
&nbsp;case class LangSelectorRequest()
&nbsp;
&nbsp;case class LangSelectorResponse(langSelectorHtml: String)
&nbsp;
&nbsp;trait JsonSupport extends DefaultJsonProtocol with SprayJsonSupport {
&nbsp;  implicit val evalRequestFormat: RootJsonFormat[EvalRequest] = jsonFormat1(EvalRequest.apply)
&nbsp;  implicit val nodeResponseFormat: RootJsonFormat[NodeResponse] = jsonFormat2(NodeResponse.apply)
&nbsp;  implicit val actionRequestFormat: RootJsonFormat[ActionRequest] = jsonFormat6(ActionRequest.apply)
&nbsp;  implicit val langSelectorRequestFormat: RootJsonFormat[LangSelectorRequest] = jsonFormat0(LangSelectorRequest.apply)
&nbsp;  implicit val langSelectorResponseFormat: RootJsonFormat[LangSelectorResponse] = jsonFormat1(
&nbsp;    LangSelectorResponse.apply
&nbsp;  )
&nbsp;}
&nbsp;
<b class="pc">&nbsp;val customExceptionHandler: ExceptionHandler = ExceptionHandler { case exception: Exception =&gt;</b>
<b class="fc">&nbsp;  extractUri { uri =&gt;</b>
<b class="fc">&nbsp;    exception.printStackTrace()</b>
&nbsp;
<b class="fc">&nbsp;    val statusCode = exception match {</b>
<b class="fc">&nbsp;      case _: IllegalArgumentException =&gt; StatusCodes.BadRequest</b>
<b class="fc">&nbsp;      case _                           =&gt; StatusCodes.InternalServerError</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    complete(HttpResponse(statusCode, entity = exception.toString))</b>
<b class="pc">&nbsp;  }</b>
&nbsp;}
&nbsp;
<b class="pc">&nbsp;class WebServer extends JsonSupport {</b>
<b class="fc">&nbsp;  private val webappDirectory: String = &quot;webapp&quot;</b>
<b class="fc">&nbsp;  private val distDirectory: String = s&quot;$webappDirectory/dist&quot;</b>
<b class="fc">&nbsp;  private val imagesDirectory: String = s&quot;$webappDirectory/images&quot;</b>
<b class="fc">&nbsp;  private val indexPage: String = s&quot;$distDirectory/index.html&quot;</b>
&nbsp;
<b class="fc">&nbsp;  private var _isOnline: Boolean = false</b>
&nbsp;
<b class="fc">&nbsp;  def isOnline: Boolean = _isOnline</b>
&nbsp;
<b class="nc">&nbsp;  private def isOnline_=(value: Boolean): Unit = _isOnline = value</b>
&nbsp;
<b class="fc">&nbsp;  private var _portNumber: Int = 27019</b>
&nbsp;
<b class="fc">&nbsp;  def portNumber: Int = _portNumber</b>
&nbsp;
&nbsp;  def portNumber_=(value: Int): Unit = {
<b class="pc">&nbsp;    if (isOnline) throw new IllegalStateException(&quot;Cannot change port number while server is online&quot;)</b>
<b class="fc">&nbsp;    if (value &lt;= 0 || value &gt; 65535) {</b>
<b class="fc">&nbsp;      throw new IllegalArgumentException(&quot;Port number must be between 1 and 65535&quot;)</b>
&nbsp;    }
<b class="fc">&nbsp;    _portNumber = value</b>
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  private var _bindingAddress: String = &quot;0.0.0.0&quot;</b>
&nbsp;
<b class="fc">&nbsp;  def bindingAddress: String = _bindingAddress</b>
&nbsp;
&nbsp;  def bindingAddress_=(value: String): Unit = {
&nbsp;    def invalidOctet(octet: Int): Boolean = {
<b class="pc">&nbsp;      octet &lt; 0 || octet &gt; 255 || octet.toString.toInt != octet</b>
&nbsp;    }
&nbsp;
<b class="pc">&nbsp;    if (isOnline) throw new IllegalStateException(&quot;Cannot change binding address while server is online&quot;)</b>
<b class="fc">&nbsp;    val ipAddressPattern = &quot;&quot;&quot;^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$&quot;&quot;&quot;.r</b>
<b class="fc">&nbsp;    ipAddressPattern.findFirstMatchIn(value) match {</b>
<b class="fc">&nbsp;      case Some(matchResult) =&gt;</b>
<b class="fc">&nbsp;        val octets = matchResult.subgroups.map(_.toInt)</b>
<b class="fc">&nbsp;        if (octets.exists(invalidOctet)) {</b>
<b class="fc">&nbsp;          throw new IllegalArgumentException(&quot;Invalid IP address&quot;)</b>
&nbsp;        }
<b class="fc">&nbsp;        _bindingAddress = s&quot;${octets.mkString(&quot;.&quot;)}&quot;</b>
<b class="pc">&nbsp;      case None =&gt; throw new IllegalArgumentException(&quot;Invalid IP address&quot;)</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  private var _skipBundleScripts: Boolean = false</b>
&nbsp;
<b class="fc">&nbsp;  def skipBundleScripts: Boolean = _skipBundleScripts</b>
&nbsp;
&nbsp;  def skipBundleScripts_=(value: Boolean): Unit = {
<b class="pc">&nbsp;    if (isOnline) throw new IllegalStateException(&quot;Cannot change skipBundleScripts while server is online&quot;)</b>
<b class="fc">&nbsp;    _skipBundleScripts = value</b>
&nbsp;  }
&nbsp;
&nbsp;  def runServer(args: Array[String]): Unit = {
<b class="nc">&nbsp;    val parseSuccess: Boolean = parseArgs(args)</b>
<b class="nc">&nbsp;    if (!parseSuccess) {</b>
<b class="nc">&nbsp;      println(&quot;Failed to parse arguments&quot;)</b>
<b class="nc">&nbsp;      System.exit(1)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    implicit val system: ActorSystem = ActorSystem(&quot;ClickDeduceWebServer&quot;)</b>
<b class="nc">&nbsp;    implicit val executionContext: ExecutionContextExecutor = system.dispatcher</b>
&nbsp;
<b class="nc">&nbsp;    if (skipBundleScripts) {</b>
<b class="nc">&nbsp;      println(&quot;Script bundling was skipped\n&quot;)</b>
&nbsp;    } else {
<b class="nc">&nbsp;      bundleScripts()</b>
<b class="nc">&nbsp;      println(&quot;\nSuccessfully bundled scripts\n\n&quot;)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val defaultSettings = ServerSettings(system)</b>
<b class="nc">&nbsp;    val customSettings = defaultSettings.withTransparentHeadRequests(true)</b>
&nbsp;
<b class="nc">&nbsp;    isOnline = true</b>
<b class="nc">&nbsp;    val bindingFuture = Http().newServerAt(bindingAddress, portNumber).withSettings(customSettings).bind(requestRoute)</b>
&nbsp;
<b class="nc">&nbsp;    println(s&quot;Server online at http://localhost:$portNumber/&quot;)</b>
&nbsp;    // StdIn.readLine()
&nbsp;
<b class="nc">&nbsp;    while (isOnline) {</b>
<b class="nc">&nbsp;      Thread.sleep(1000)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    bindingFuture</b>
<b class="nc">&nbsp;      .flatMap(_.unbind())</b>
<b class="nc">&nbsp;      .onComplete(_ =&gt; system.terminate())</b>
<b class="nc">&nbsp;    isOnline = false</b>
&nbsp;  }
&nbsp;
&nbsp;  def parseArgs(args: Array[String]): Boolean = {
<b class="pc">&nbsp;    val parser = new scopt.OptionParser[Unit](&quot;WebServer&quot;) {</b>
<b class="fc">&nbsp;      opt[Int](&quot;port&quot;)</b>
<b class="fc">&nbsp;        .action((x, _) =&gt; portNumber = x)</b>
<b class="fc">&nbsp;        .text(&quot;Port number to bind&quot;)</b>
&nbsp;
<b class="fc">&nbsp;      opt[String](&quot;address&quot;)</b>
<b class="fc">&nbsp;        .action((x, _) =&gt; bindingAddress = x)</b>
<b class="fc">&nbsp;        .text(&quot;Binding address&quot;)</b>
&nbsp;
<b class="fc">&nbsp;      opt[Unit](&quot;skip-bundle-scripts&quot;)</b>
<b class="fc">&nbsp;        .action((_, _) =&gt; skipBundleScripts = true)</b>
<b class="fc">&nbsp;        .text(&quot;Skip bundling scripts&quot;)</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
<b class="fc">&nbsp;    parser.parse(args, ()).isDefined</b>
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  val knownLanguages: List[ClickDeduceLanguage] = List(LArith(), LIf(), LLet(), LLam(), LRec())</b>
&nbsp;
<b class="fc">&nbsp;  private def getLanguage(langName: String): ClickDeduceLanguage = knownLanguages</b>
<b class="pc">&nbsp;    .find(getLanguageName(_) == langName) match {</b>
<b class="fc">&nbsp;    case Some(lang) =&gt; lang</b>
<b class="pc">&nbsp;    case None       =&gt; throw new IllegalArgumentException(s&quot;Unknown language: $langName&quot;)</b>
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  def getLanguageName(lang: ClickDeduceLanguage): String = lang.getClass.getSimpleName.stripSuffix(&quot;$&quot;)</b>
&nbsp;
&nbsp;  private def bundleScripts(): Unit = {
<b class="nc">&nbsp;    println(&quot;Bundling scripts...&quot;)</b>
&nbsp;
<b class="nc">&nbsp;    val osName = System.getProperty(&quot;os.name&quot;).toLowerCase</b>
<b class="nc">&nbsp;    val command = if (osName.contains(&quot;win&quot;)) &quot;cmd.exe /c npm run build&quot; else &quot;npm run build&quot;</b>
&nbsp;
<b class="nc">&nbsp;    val process = Process(command, new File(&quot;webapp&quot;)).!</b>
&nbsp;
<b class="nc">&nbsp;    if (process != 0) {</b>
<b class="nc">&nbsp;      System.exit(process)</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private def resourceNotFoundResponse: HttpResponse =
<b class="fc">&nbsp;    HttpResponse(StatusCodes.NotFound, entity = HttpEntity(&quot;The requested resource could not be found.&quot;))</b>
&nbsp;
<b class="fc">&nbsp;  val requestRoute: Route = handleExceptions(customExceptionHandler) {</b>
<b class="fc">&nbsp;    post {</b>
<b class="fc">&nbsp;      path(&quot;start-node-blank&quot;) {</b>
<b class="fc">&nbsp;        entity(as[EvalRequest]) { request =&gt;</b>
<b class="fc">&nbsp;          val lang = getLanguage(request.langName)</b>
<b class="fc">&nbsp;          val tree = lang.ExprChoiceNode()</b>
<b class="fc">&nbsp;          val response = NodeResponse(tree.toString, tree.toHtml(lang.DisplayMode.Edit).toString)</b>
<b class="fc">&nbsp;          complete(response)</b>
&nbsp;        }
<b class="fc">&nbsp;      } ~</b>
<b class="fc">&nbsp;        path(&quot;process-action&quot;) {</b>
<b class="fc">&nbsp;          entity(as[ActionRequest]) { request =&gt;</b>
<b class="fc">&nbsp;            val lang = getLanguage(request.langName)</b>
<b class="fc">&nbsp;            val action = lang.createAction(</b>
<b class="fc">&nbsp;              request.actionName,</b>
<b class="fc">&nbsp;              request.nodeString,</b>
<b class="fc">&nbsp;              request.treePath,</b>
<b class="fc">&nbsp;              request.extraArgs,</b>
<b class="fc">&nbsp;              request.modeName</b>
&nbsp;            )
<b class="fc">&nbsp;            val updatedTree = action.newTree</b>
<b class="fc">&nbsp;            val displayMode: lang.DisplayMode = lang.DisplayMode.fromString(request.modeName)</b>
<b class="fc">&nbsp;            val response = NodeResponse(updatedTree.toString, updatedTree.toHtml(displayMode).toString)</b>
<b class="fc">&nbsp;            complete(response)</b>
&nbsp;          }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;    } ~</b>
<b class="fc">&nbsp;      get {</b>
<b class="fc">&nbsp;        path(&quot;get-lang-selector&quot;) {</b>
<b class="fc">&nbsp;          val langSelector: TypedTag[String] = select(</b>
<b class="fc">&nbsp;            id := &quot;lang-selector&quot;,</b>
<b class="fc">&nbsp;            name := &quot;lang-name&quot;,</b>
<b class="fc">&nbsp;            knownLanguages.map(lang =&gt; option(value := getLanguageName(lang), getLanguageName(lang)))</b>
&nbsp;          )
<b class="fc">&nbsp;          val response = LangSelectorResponse(langSelector.toString)</b>
<b class="fc">&nbsp;          complete(response)</b>
<b class="fc">&nbsp;        } ~</b>
<b class="fc">&nbsp;          pathEndOrSingleSlash { getFromFile(indexPage) } ~</b>
<b class="fc">&nbsp;          pathPrefix(&quot;dist&quot;) { getFromDirectory(distDirectory) } ~</b>
<b class="fc">&nbsp;          pathPrefix(&quot;images&quot;) { getFromDirectory(imagesDirectory) } ~</b>
<b class="fc">&nbsp;          pathPrefix(&quot;scripts&quot;) { complete(resourceNotFoundResponse) } ~</b>
<b class="fc">&nbsp;          pathPrefix(&quot;styles&quot;) { complete(resourceNotFoundResponse) } ~</b>
<b class="fc">&nbsp;          pathPrefix(&quot;pages&quot;) { complete(resourceNotFoundResponse) } ~</b>
<b class="fc">&nbsp;          getFromDirectory(distDirectory)</b>
<b class="fc">&nbsp;      }</b>
<b class="fc">&nbsp;  }</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;object WebServer {</b>
<b class="nc">&nbsp;  def main(args: Array[String]): Unit = {</b>
<b class="nc">&nbsp;    val server = new WebServer()</b>
<b class="nc">&nbsp;    server.runServer(args)</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-01-22 16:28</div>
</div>
</body>
</html>
