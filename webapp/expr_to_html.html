<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="stylesheet.css">
  <title>Expr2HTML</title>
</head>

<body>

<h2>Expression to HTML Conversion</h2>

<form onsubmit="handleSubmit(event, '/expr-to-html-tree')">
  <input type="text" id="userInput" placeholder="Enter Expression">
  <input type="submit" value="Evaluate">
</form>
<form onsubmit="handleSubmit(event, '/expr-to-html-tree-blank')">
  <input type="hidden" id="blankUserInput" value="">
  <input type="submit" value="Evaluate Blank">
</form>
<form onsubmit="handleSubmit(event, '/start-node-blank')">
  <input type="hidden" id="nodeUserInput" value="">
  <input type="submit" value="Start Node Blank">
</form>
<br>

<div id="tree"></div>

<script>
  var lastNodeString = "";
  let treeContainer = document.getElementById('tree');

  async function handleSubmit(event, url) {
    // prevent the form from submitting the old-fashioned way
    event.preventDefault();

    // get the user's input
    let userInput = document.getElementById('userInput').value;

    // send a POST request to the server
    let response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: userInput
      })
    });

    // read the response as text
    let jsonResponse = await response.json();

    // the svgText is the SVG string directly without the JSON structure:
    treeContainer.innerHTML = jsonResponse.html;
    lastNodeString = jsonResponse.nodeString;
  }

  function handleDropdownChange(dropdown) {
    const selectedValue = dropdown.value;
    const subtree = dropdown.parentElement.parentElement;
    const dataTreePath = subtree.getAttribute("data-tree-path")

    runAction("SelectExprAction", dataTreePath, [selectedValue])
  }

  function handleLiteralChanged(textInput) {
    const literalValue = textInput.value;
    const treePath = textInput.getAttribute("data-tree-path")

    runAction("EditLiteralAction", treePath, [literalValue])
  }

  function runAction(actionName, treePath, extraArgs) {
    fetch("/process-action", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        actionName,
        nodeString: lastNodeString,
        treePath,
        extraArgs
      })
    }).then(response => response.json()).then(updatedTree => {
      treeContainer.innerHTML = updatedTree.html;
      lastNodeString = updatedTree.nodeString;
    })
  }
</script>

</body>
</html>
